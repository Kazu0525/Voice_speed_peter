<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éŸ³å£°å…¥åŠ›ã‚²ãƒ¼ãƒ </title>

<style>
:root {
  --primary-color: #4f46e5;
  --secondary-color: #7c3aed;
  --background-start: #667eea;
  --background-end: #764ba2;
  --text-light: #ffffff;
  --text-dark: #1e293b;
  --container-bg: #ffffff;
  --correct-color: #10b981;
  --incorrect-color: #ef4444;
  --font-family: 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font-family);
  background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
  min-height: 100vh;
  padding: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.container {
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  background: var(--container-bg);
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: var(--text-light);
  padding: 20px 30px;
  text-align: center;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-content {
  text-align: left;
}

.btn-sound {
  background: none;
  border: 2px solid var(--text-light);
  color: var(--text-light);
  width: 45px;
  height: 45px;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-sound:hover {
  background: rgba(255, 255, 255, 0.2);
}

.header h1 {
  font-size: 2rem;
  font-weight: 700;
}

.header p {
  font-size: 1rem;
  opacity: 0.9;
}

.main-content {
  padding: 30px;
}

.game-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.game-info {
  display: flex;
  justify-content: space-around;
  background: #f8fafc;
  padding: 15px;
  border-radius: 15px;
  border: 2px solid #e2e8f0;
}

.info-item {
  text-align: center;
}

.info-label {
  display: block;
  font-size: 0.9rem;
  color: #64748b;
  margin-bottom: 5px;
}

.info-value {
  font-size: 1.8rem;
  font-weight: bold;
  color: var(--primary-color);
  transition: all 0.3s ease;
}

/* ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

/* ç·Šå¼µæ„Ÿã‚’æ¼”å‡ºã™ã‚‹ã‚°ãƒ­ãƒ¼åŠ¹æœ */
.timer-warning {
  animation: pulse 1s infinite;
  color: #ef4444 !important;
  text-shadow: 0 0 10px #ef4444;
}

.question-area {
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  border: 2px solid #7dd3fc;
  border-radius: 15px;
  padding: 30px;
  text-align: center;
  min-height: 120px;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.3s ease;
}

/* ç·Šå¼µçŠ¶æ…‹ã§ã®å•é¡Œã‚¨ãƒªã‚¢ */
.question-area.tense {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  border-color: #fca5a5;
  animation: subtle-shake 0.1s infinite;
}

@keyframes subtle-shake {
  0%, 100% { transform: translateX(0); }
  50% { transform: translateX(1px); }
}

.question-text {
  font-size: 2rem;
  font-weight: bold;
  color: var(--text-dark);
}

.result-display {
  text-align: center;
  font-size: 2.5rem;
  font-weight: bold;
  height: 50px;
}

.result-display.correct {
  color: var(--correct-color);
  animation: bounce 0.5s ease;
}

.result-display.incorrect {
  color: var(--incorrect-color);
  animation: shake 0.5s ease;
}

@keyframes bounce {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.recognized-text-area {
  background: #f8fafc;
  border-radius: 10px;
  padding: 15px;
  min-height: 80px;
  text-align: center;
  color: #475569;
}

#recognized-text {
  font-size: 1.2rem;
}

#interim-text {
  font-size: 1rem;
  color: #94a3b8;
}

.controls {
  display: flex;
  justify-content: center;
  gap: 15px;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
}

.btn-secondary {
  background: #6b7280;
  color: white;
}

.btn-secondary:hover {
  background: #4b5563;
}

.btn-secondary.selected {
  background: var(--primary-color);
  transform: scale(1.05);
}

.btn-danger {
  background: #ef4444;
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.mic-status {
  text-align: center;
  background: #fffbeb;
  padding: 15px;
  border-radius: 10px;
  border: 1px solid #fef3c7;
  color: #b45309;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  animation: slide-up 0.5s ease-out;
}

.modal-content h2 {
  font-size: 2.5rem;
  margin-bottom: 20px;
  color: var(--primary-color);
}

.final-score {
  margin-bottom: 30px;
  font-size: 1.2rem;
}

.final-score p {
  margin: 10px 0;
}

.final-score span {
  font-weight: bold;
  font-size: 1.5rem;
}

@keyframes slide-up {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.difficulty-selector {
  text-align: center;
  padding: 30px;
  background: #f8fafc;
  border-radius: 15px;
  margin-bottom: 20px;
}

.difficulty-selector h2 {
  margin-bottom: 20px;
  color: var(--text-dark);
}

/* ã‚³ãƒ³ãƒœè¡¨ç¤ºã®å¼·åŒ– */
.combo-highlight {
  color: #f59e0b !important;
  animation: glow 1s infinite alternate;
}

@keyframes glow {
  from { text-shadow: 0 0 5px #f59e0b; }
  to { text-shadow: 0 0 20px #f59e0b; }
}

@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  
  .header h1 {
    font-size: 1.8rem;
  }
  
  .main-content {
    padding: 15px;
  }
  
  .question-text {
    font-size: 1.5rem;
  }
  
  .game-info {
    flex-direction: column;
    gap: 15px;
  }
  
  .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-align: left;
  }
  
  .modal-content {
    padding: 20px;
    margin: 10px;
    max-width: 90vw;
  }
  
  .controls {
    flex-direction: column;
    gap: 10px;
  }
  
  .btn {
    width: 100%;
  }
}
</style>

</head>
<body>
<div class="container">
<div class="header">
  <div class="header-content">
    <h1>ğŸ¤ éŸ³å£°å…¥åŠ›ã‚²ãƒ¼ãƒ  ğŸ£</h1>
    <p>è¡¨ç¤ºã•ã‚Œã‚‹ãŠé¡Œã‚’ç´ æ—©ãæ­£ç¢ºã«èª­ã¿ä¸Šã’ã‚ˆã†ï¼</p>
  </div>
  <div class="sound-control">
    <button id="sound-toggle" class="btn-sound">ğŸ”Š</button>
  </div>
</div>

<div class="main-content">
<div id="mic-status" class="mic-status">
  <p>ã¾ãšã€ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«ãƒã‚¤ã‚¯ã®è¨±å¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
  <button class="btn btn-primary" id="mic-permission-button">ãƒã‚¤ã‚¯ã‚’è¨±å¯</button>
</div>

<div id="difficulty-selector" class="difficulty-selector" style="display: none;">
  <h2>é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
  <div class="controls">
    <button class="btn btn-secondary difficulty-btn" data-difficulty="easy">ç°¡å˜</button>
    <button class="btn btn-secondary difficulty-btn" data-difficulty="normal">æ™®é€š</button>
    <button class="btn btn-secondary difficulty-btn" data-difficulty="hard">é›£ã—ã„</button>
  </div>
</div>

<div class="game-container" style="display: none;">
  <div class="game-info">
    <div class="info-item">
      <span class="info-label">ã‚¹ã‚³ã‚¢</span>
      <span id="score" class="info-value">0</span>
    </div>
    <div class="info-item">
      <span class="info-label">æ®‹ã‚Šæ™‚é–“</span>
      <span id="timer" class="info-value">60</span>
    </div>
    <div class="info-item">
      <span class="info-label">ã‚³ãƒ³ãƒœ</span>
      <span id="combo" class="info-value">0</span>
    </div>
  </div>

  <div id="question-area" class="question-area">
    <p id="question-text" class="question-text">ã“ã“ã«èª²é¡Œæ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
  </div>

  <div id="result-display" class="result-display"></div>

  <div id="recognized-text-area" class="recognized-text-area">
    <p id="recognized-text">ã“ã“ã«èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</p>
    <p id="interim-text" class="interim-text"></p>
  </div>

  <div class="controls">
    <button class="btn btn-primary" id="start-button">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    <button class="btn btn-danger" id="stop-button" style="display: none;">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
  </div>
</div>

<div id="game-over-modal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <h2>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼</h2>
    <div class="final-score">
      <p>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span></p>
      <p>æœ€å¤§ã‚³ãƒ³ãƒœ: <span id="max-combo">0</span></p>
      <p>æ­£è§£æ•°: <span id="correct-count">0</span></p>
      <p>ãƒŸã‚¹æ•°: <span id="miss-count">0</span></p>
    </div>
    <button class="btn btn-primary" id="restart-button">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
  </div>
</div>
</div>
</div>

<!-- è¤‡æ•°ã®BGMã‚’è¿½åŠ  -->
<!-- é€šå¸¸æ™‚ã®BGMï¼ˆè»½ã‚„ã‹ã§æ¥½ã—ã„é›°å›²æ°—ï¼‰ -->
<audio id="bgm" loop preload="auto">
  <source src="https://archive.org/download/A_New_Day-4334/A_New_Day-4334.mp3" type="audio/mpeg">
  <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®åˆ¥ã®BGM -->
  <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
</audio>

<!-- ç·Šå¼µæ„Ÿã®ã‚ã‚‹BGMï¼ˆæ™‚é–“ãŒå°‘ãªããªã£ãŸæ™‚ç”¨ï¼‰ -->
<audio id="tense-bgm" loop preload="auto">
  <!-- ç·Šå¼µæ„Ÿã®ã‚ã‚‹BGMã®URLï¼ˆå®Ÿéš›ã®ä½¿ç”¨æ™‚ã¯é©åˆ‡ãªã‚‚ã®ã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰ -->
  <source src="https://archive.org/download/tensionmusic/tension.mp3" type="audio/mpeg">
  <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚ˆã‚Šæ—©ã„ãƒ†ãƒ³ãƒã®éŸ³æ¥½ -->
  <source src="https://www.soundjay.com/misc/sounds/clock-ticking-3.wav" type="audio/wav">
</audio>

<!-- wanaKana.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆã²ã‚‰ãŒãªå¤‰æ›ç”¨ï¼‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wanakana/5.3.1/wanakana.min.js"></script>

<script>
// questions.jsã®å†…å®¹ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–
const questions = {
  easy: [
    // åŸºæœ¬çš„ãªæŒ¨æ‹¶
    "ã“ã‚“ã«ã¡ã¯", "ã‚ã‚ŠãŒã¨ã†", "ã•ã‚ˆã†ãªã‚‰", "ãŠã¯ã‚ˆã†", "ãŠã‚„ã™ã¿",
    "ã‚ˆã‚ã—ã", "ãŠã­ãŒã„ã—ã¾ã™", "ã™ã¿ã¾ã›ã‚“", "ã”ã‚ã‚“ãªã•ã„", "ã„ãŸã ãã¾ã™",
    "ã”ã¡ãã†ã•ã¾", "ã¯ã„", "ã„ã„ãˆ", "ãŠã¤ã‹ã‚Œã•ã¾", "ã„ã£ã¦ãã¾ã™",
    "ãŸã ã„ã¾", "ãŠã‹ãˆã‚Š", "ã“ã‚“ã°ã‚“ã¯", "ã¯ã˜ã‚ã¾ã—ã¦", "ã—ã¤ã‚Œã„ã—ã¾ã™",
    
    // å‹•ç‰©
    "ã„ã¬", "ã­ã“", "ã†ã¾", "ã†ã—", "ã¶ãŸ", "ã²ã¤ã˜", "ã‚„ã", "ã«ã‚ã¨ã‚Š",
    "ã†ã•ã", "ã­ãšã¿", "ã¨ã‚Š", "ã•ã‹ãª", "ã‹ã‚", "ã¸ã³", "ã¨ã‚‰", "ãã†",
    "ãã‚Šã‚“", "ã•ã‚‹", "ãã¾", "ã‚‰ã„ãŠã‚“", "ã±ã‚“ã ", "ãºã‚“ãã‚“", "ã„ã‚‹ã‹", "ãã˜ã‚‰",
    
    // é£Ÿã¹ç‰©
    "ã‚Šã‚“ã”", "ã¿ã‹ã‚“", "ã°ãªãª", "ã„ã¡ã”", "ã¶ã©ã†", "ãªã—", "ã‚‚ã‚‚", "ã™ã„ã‹",
    "ã‚ã‚ã‚“", "ã”ã¯ã‚“", "ã±ã‚“", "ã¿ãš", "ãŠã¡ã‚ƒ", "ãã‚…ã†ã«ã‚…ã†", "ãŸã¾ã”", "ã«ã",
    "ã‚„ã•ã„", "ã•ã‹ãª", "ãã ã‚‚ã®", "ãŠã‹ã—", "ã‘ãƒ¼ã", "ã‚ã„ã™", "ã˜ã‚…ãƒ¼ã™", "ã“ãƒ¼ã²ãƒ¼"
  ],

  normal: [
    "ä»Šæ—¥ã®å¤©æ°—ã¯æ™´ã‚Œã§ã™", "æ˜æ—¥ã¯é›¨ãŒé™ã‚‹ã§ã—ã‚‡ã†", "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®é›»æºã‚’å…¥ã‚Œã‚‹",
    "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§æƒ…å ±ã‚’æ¢ã™", "ã“ã‚Œã¯ç§ã®å¥½ããªæœ¬ã§ã™", "å…¬åœ’ã‚’æ•£æ­©ã™ã‚‹ã®ãŒå¥½ãã§ã™",
    "æ–°ã—ã„è¨€èªã‚’å‹‰å¼·ã—ã¦ã„ã¾ã™", "é€±æœ«ã¯æ˜ ç”»ã‚’è¦‹ã«è¡Œãã¾ã™", "ãŠæ˜¼ã”é£¯ã¯ä½•ã‚’é£Ÿã¹ã‚ˆã†ã‹",
    "é›»è»Šã«ä¹—ã£ã¦ä¼šç¤¾ã¸è¡Œã", "ä¼šè­°ã®æº–å‚™ã‚’ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„", "å‹é”ã¨é›»è©±ã§è©±ã—ã¾ã—ãŸ",
    "ã“ã®æ–™ç†ã¯ã¨ã¦ã‚‚ç¾å‘³ã—ã„", "éŸ³å£°å…¥åŠ›ã®ãƒ†ã‚¹ãƒˆä¸­ã§ã™", "é§…ã¾ã§æ­©ã„ã¦10åˆ†ã§ã™",
    "è¶£å‘³ã¯èª­æ›¸ã¨éŸ³æ¥½ã§ã™", "æ˜æ—¥ã®äºˆå®šã‚’ç¢ºèªã—ã¾ã™", "éƒ¨å±‹ã®æƒé™¤ã‚’ã—ã¾ã—ãŸ",
    "æ–°ã—ã„é´ã‚’è²·ã„ã¾ã—ãŸ", "å›³æ›¸é¤¨ã§æœ¬ã‚’å€Ÿã‚Šã¾ã™", "çŒ«ãŒè†ã®ä¸Šã§å¯ã¦ã„ã¾ã™"
  ],

  hard: [
    "æ±äº¬ç‰¹è¨±è¨±å¯å±€é•·å®˜", "ç”Ÿéº¦ç”Ÿç±³ç”Ÿåµ", "éš£ã®å®¢ã¯ã‚ˆãæŸ¿é£Ÿã†å®¢ã ",
    "èµ¤å·»ç´™é’å·»ç´™é»„å·»ç´™", "ã“ã®ç«¹å£ã«ç«¹ç«‹ã¦æ›ã‘ãŸã®ã¯ç«¹ç«‹ã¦æ›ã‘ãŸã‹ã£ãŸã‹ã‚‰ç«¹ç«‹ã¦æ›ã‘ãŸ",
    "ã™ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã®ã†ã¡", "åŠä¸»ãŒå±é¢¨ã«ä¸Šæ‰‹ã«åŠä¸»ã®çµµã‚’æã„ãŸ",
    "ãƒã‚µãƒãƒ¥ãƒ¼ã‚»ãƒƒãƒ„å·", "ã‚ˆã¼ã‚ˆã¼ç—…äºˆé˜²ç—…é™¢äºˆé˜²ç—…å®¤", "éª¨ç²—é¬†ç—‡äºˆé˜²æ³•",
    "è²¨å®¢èˆ¹ã®æ—…å®¢ã¨æ—…å®¢æ©Ÿã®æ—…å®¢", "æ´¾å‡ºæ‰€ã§æ‰‹è¡“ä¸­", "ãã‚ƒã‚Šãƒ¼ã±ã¿ã‚…ã±ã¿ã‚…",
    "æ‘˜å‡ºæ‰‹è¡“", "è€è‹¥ç”·å¥³", "è‘—ä½œæ¨©ä¾µå®³", "é«˜æ‰€ææ€–ç—‡",
    "ã‚¢ãƒ–ãƒ©ã‚«ãƒ€ãƒ–ãƒ©", "ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‰ãƒ¡ã‚¤ãƒ³", "ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£"
  ]
};

// ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ”¹è‰¯ç‰ˆBGMã‚·ã‚¹ãƒ†ãƒ ä»˜ãï¼‰
document.addEventListener('DOMContentLoaded', () => {
  
  // DOMè¦ç´ ã‚’å–å¾—
  const scoreEl = document.getElementById('score');
  const timerEl = document.getElementById('timer');
  const comboEl = document.getElementById('combo');
  const questionTextEl = document.getElementById('question-text');
  const resultDisplayEl = document.getElementById('result-display');
  const recognizedTextEl = document.getElementById('recognized-text');
  const interimTextEl = document.getElementById('interim-text');
  
  const startButton = document.getElementById('start-button');
  const stopButton = document.getElementById('stop-button');
  const micPermissionButton = document.getElementById('mic-permission-button');
  const restartButton = document.getElementById('restart-button');
  const soundToggleButton = document.getElementById('sound-toggle');
  
  const micStatusEl = document.getElementById('mic-status');
  const gameOverModal = document.getElementById('game-over-modal');
  const difficultySelectorEl = document.getElementById('difficulty-selector');
  const gameContainerEl = document.querySelector('.game-container');
  const questionAreaEl = document.getElementById('question-area');
  
  const finalScoreEl = document.getElementById('final-score');
  const maxComboEl = document.getElementById('max-combo');
  const correctCountEl = document.getElementById('correct-count');
  const missCountEl = document.getElementById('miss-count');
  
  const difficultyButtons = document.querySelectorAll('.difficulty-btn');
  
  // BGMéŸ³å£°è¦ç´ 
  const bgmEl = document.getElementById('bgm');
  const tenseBgmEl = document.getElementById('tense-bgm');
  
  // éŸ³å£°é–¢é€£ã®è¨­å®š
  let isMuted = false;
  let audioUnlocked = false;
  
  // åŠ¹æœéŸ³ã¨BGMã®è¨­å®š
  const sounds = {
    start: new Audio('https://soundeffect-lab.info/sound/button/mp3/decision18.mp3'),
    correct: new Audio('https://soundeffect-lab.info/sound/button/mp3/decision22.mp3'),
    incorrect: new Audio('https://soundeffect-lab.info/sound/button/mp3/beep4.mp3'),
    comboSound: new Audio('https://soundeffect-lab.info/sound/button/mp3/decision1.mp3'),
    timeWarning: new Audio('https://soundeffect-lab.info/sound/button/mp3/beep7.mp3')
  };
  
  // BGMã®è¨­å®š
  function setupBGM() {
    bgmEl.volume = 0.3;
    bgmEl.loop = true;
    
    if (tenseBgmEl) {
      tenseBgmEl.volume = 0.4;
      tenseBgmEl.loop = true;
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    bgmEl.addEventListener('error', (e) => {
      console.warn('é€šå¸¸BGM loading failed, using fallback');
    });
    
    if (tenseBgmEl) {
      tenseBgmEl.addEventListener('error', (e) => {
        console.warn('ç·Šå¼µBGM loading failed, using fallback');
      });
    }
  }
  
  // BGMãƒ•ã‚§ãƒ¼ãƒ‰æ©Ÿèƒ½
  function fadeAudio(audio, targetVolume, duration = 1000) {
    if (!audio) return;
    
    const startVolume = audio.volume;
    const volumeStep = (targetVolume - startVolume) / (duration / 50);
    
    const fade = setInterval(() => {
      const newVolume = audio.volume + volumeStep;
      
      if ((volumeStep > 0 && newVolume >= targetVolume) || 
          (volumeStep < 0 && newVolume <= targetVolume)) {
        audio.volume = Math.max(0, Math.min(1, targetVolume));
        clearInterval(fade);
        
        if (targetVolume === 0) {
          audio.pause();
        }
      } else {
        audio.volume = Math.max(0, Math.min(1, newVolume));
      }
    }, 50);
  }
  
  // æ”¹è‰¯ã•ã‚ŒãŸBGMå†ç”Ÿæ©Ÿèƒ½
  function playBGM(intense = false) {
    if (isMuted || !audioUnlocked) return;
    
    try {
      // ç¾åœ¨ã®BGMã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
      if (!bgmEl.paused) {
        fadeAudio(bgmEl, 0, 500);
      }
      if (tenseBgmEl && !tenseBgmEl.paused) {
        fadeAudio(tenseBgmEl, 0, 500);
      }
      
      // æ–°ã—ã„BGMã‚’å†ç”Ÿ
      setTimeout(() => {
        const targetBGM = intense ? (tenseBgmEl || bgmEl) : bgmEl;
        if (targetBGM) {
          targetBGM.currentTime = 0;
          targetBGM.volume = 0;
          targetBGM.play().then(() => {
            fadeAudio(targetBGM, intense ? 0.4 : 0.3, 1000);
          }).catch(e => console.error("BGM play failed:", e));
        }
      }, 500);
      
    } catch (e) {
      console.error("BGM control error:", e);
    }
  }
  
  function unlockAudio() {
    if (audioUnlocked) return;
    
    const allSounds = [bgmEl, tenseBgmEl, ...Object.values(sounds)].filter(Boolean);
    allSounds.forEach(sound => {
      sound.play().catch(() => {});
      sound.pause();
      sound.currentTime = 0;
    });
    audioUnlocked = true;
    console.log("Audio context unlocked.");
  }
  
  function playSound(sound) {
    if (!isMuted && audioUnlocked && sounds[sound]) {
      sounds[sound].currentTime = 0;
      sounds[sound].play().catch(e => console.error("Error playing sound:", e));
    }
  }
  
  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®å¤‰æ•°
  let gameActive = false;
  let currentDifficulty = 'normal';
  let score = 0;
  let time = 60;
  let combo = 0;
  let maxCombo = 0;
  let correctCount = 0;
  let missCount = 0;
  let timerInterval = null;
  let currentQuestion = '';
  let timeWarningPlayed = false;
  
  // ãƒã‚¤ã‚¯è¨±å¯ã®ç®¡ç†
  const isMicGranted = () => localStorage.getItem('micGranted') === 'true';
  const setMicGranted = () => localStorage.setItem('micGranted', 'true');
  
  // éŸ³å£°èªè­˜ã®è¨­å®š
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition;
  
  if (!SpeechRecognition) {
    micStatusEl.innerHTML = '<p>ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
    return;
  }
  
  recognition = new SpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.interimResults = true;
  recognition.continuous = false;
  
  // åˆæœŸåŒ–é–¢æ•°
  function initialize() {
    setupBGM();
    
    if (isMicGranted()) {
      showDifficultySelector();
    } else {
      micStatusEl.style.display = 'block';
    }
  }
  
  function showDifficultySelector() {
    micStatusEl.style.display = 'none';
    difficultySelectorEl.style.display = 'block';
    gameContainerEl.style.display = 'none';
    gameOverModal.style.display = 'none';
    
    // é¸æŠç”»é¢ã§ã‚‚è»½ã‚„ã‹ãªBGMã‚’å†ç”Ÿ
    playBGM(false);
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  micPermissionButton.addEventListener('click', async () => {
    unlockAudio();
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => track.stop());
      setMicGranted();
      showDifficultySelector();
    } catch (err) {
      micStatusEl.innerHTML = '<p>âŒ ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
      console.error('Microphone permission denied:', err);
    }
  });
  
  difficultyButtons.forEach(button => {
    button.addEventListener('click', () => {
      unlockAudio();
      currentDifficulty = button.dataset.difficulty;
      
      difficultyButtons.forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
      
      difficultySelectorEl.style.display = 'none';
      gameContainerEl.style.display = 'flex';
      
      startButton.style.display = 'inline-block';
      stopButton.style.display = 'none';
      
      resetGame();
      nextQuestion();
    });
  });
  
  startButton.addEventListener('click', startGame);
  stopButton.addEventListener('click', stopGame);
  restartButton.addEventListener('click', () => {
    showDifficultySelector();
  });
  
  soundToggleButton.addEventListener('click', () => {
    isMuted = !isMuted;
    soundToggleButton.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
    
    // BGMã®ãƒŸãƒ¥ãƒ¼ãƒˆåˆ¶å¾¡
    bgmEl.muted = isMuted;
    if (tenseBgmEl) tenseBgmEl.muted = isMuted;
    
    if (isMuted) {
      bgmEl.pause();
      if (tenseBgmEl) tenseBgmEl.pause();
    } else if (gameActive) {
      playBGM(time <= 15);
    }
  });
  
  // éŸ³å£°èªè­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  recognition.onresult = (event) => {
    if (!gameActive) return; // ã‚²ãƒ¼ãƒ éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã¯å‡¦ç†ã—ãªã„
    
    let interimTranscript = '';
    let finalTranscript = '';
    
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript;
      } else {
        interimTranscript += event.results[i][0].transcript;
      }
    }
    
    // æš«å®šçµæœã‚’è¡¨ç¤º
    interimTextEl.textContent = interimTranscript;
    
    // ç¢ºå®šçµæœãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†
    if (finalTranscript.trim()) {
      recognizedTextEl.textContent = finalTranscript;
      checkAnswer(finalTranscript);
    }
  };
  
  recognition.onend = () => {
    if (gameActive) {
      // éŸ³å£°èªè­˜ãŒäºˆæœŸã›ãšçµ‚äº†ã—ãŸå ´åˆã®å†é–‹å‡¦ç†
      setTimeout(() => {
        try {
          if (gameActive) {
            recognition.start();
          }
        } catch(e) {
          console.error("Recognition restart failed in onend:", e);
          // å†è©¦è¡Œ
          setTimeout(() => {
            if (gameActive) {
              try {
                recognition.start();
              } catch(e2) {
                console.error("Recognition restart retry failed:", e2);
              }
            }
          }, 500);
        }
      }, 100);
    }
  };
  
  recognition.onerror = (event) => {
    console.error('Speech recognition error', event.error);
  };
  
  // æ”¹è‰¯ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
  function startGame() {
    gameActive = true;
    timeWarningPlayed = false;
    
    startButton.style.display = 'none';
    stopButton.style.display = 'inline-block';
    
    // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã¯é€šå¸¸ã®BGM
    playBGM(false);
    
    timerInterval = setInterval(() => {
      time--;
      timerEl.textContent = time;
      
      // è¦–è¦šçš„ãªç·Šå¼µæ„Ÿã®æ¼”å‡º
      if (time <= 10) {
        timerEl.className = 'info-value timer-warning';
        questionAreaEl.classList.add('tense');
        
        // ç·Šå¼µæ„Ÿã®ã‚ã‚‹BGMã«åˆ‡ã‚Šæ›¿ãˆ
        if (time <= 15 && !timeWarningPlayed) {
          playBGM(true);
          playSound('timeWarning');
          timeWarningPlayed = true;
        }
      } else if (time <= 20) {
        timerEl.style.color = '#f59e0b';
      }
      
      if (time <= 0) {
        stopGame();
      }
    }, 1000);
    
    try {
      recognition.start();
    } catch(e) {
      console.error("Recognition could not be started: ", e);
    }
    
    playSound('start');
  }
  
  function stopGame() {
    gameActive = false;
    
    stopButton.style.display = 'none';
    startButton.style.display = 'inline-block';
    
    if (timerInterval) clearInterval(timerInterval);
    recognition.stop();
    
    // BGMã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    fadeAudio(bgmEl, 0, 1000);
    if (tenseBgmEl) fadeAudio(tenseBgmEl, 0, 1000);
    
    // è¦–è¦šåŠ¹æœã‚’ãƒªã‚»ãƒƒãƒˆ
    timerEl.className = 'info-value';
    timerEl.style.color = '';
    questionAreaEl.classList.remove('tense');
    
    gameOverModal.style.display = 'flex';
    finalScoreEl.textContent = score;
    maxComboEl.textContent = maxCombo;
    correctCountEl.textContent = correctCount;
    missCountEl.textContent = missCount;
  }
  
  function resetGame() {
    score = 0;
    time = 60;
    combo = 0;
    maxCombo = 0;
    correctCount = 0;
    missCount = 0;
    timeWarningPlayed = false;
    
    scoreEl.textContent = score;
    timerEl.textContent = time;
    comboEl.textContent = combo;
    recognizedTextEl.textContent = '...';
    interimTextEl.textContent = '';
    
    // è¦–è¦šåŠ¹æœã‚’ãƒªã‚»ãƒƒãƒˆ
    timerEl.className = 'info-value';
    timerEl.style.color = '';
    questionAreaEl.classList.remove('tense');
    comboEl.classList.remove('combo-highlight');
  }
  
  function nextQuestion() {
    const questionPool = questions[currentDifficulty] || questions['normal'];
    
    if (questionPool.length === 1) {
      currentQuestion = questionPool[0];
    } else {
      let newQuestion;
      do {
        newQuestion = questionPool[Math.floor(Math.random() * questionPool.length)];
      } while (newQuestion === currentQuestion && questionPool.length > 1);
      currentQuestion = newQuestion;
    }
    
    questionTextEl.textContent = currentQuestion;
    
    // å•é¡ŒãŒå¤‰ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§éŸ³å£°èªè­˜çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
    recognizedTextEl.textContent = '...';
    interimTextEl.textContent = '';
    
    console.log('æ–°ã—ã„å•é¡Œ:', currentQuestion);
  }
  
  function normalizeText(text) {
    let normalized = text;
    
    // wanaKanaãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½¿ãˆã‚‹å ´åˆã®ã¿ä½¿ç”¨
    if (typeof wanakana !== 'undefined') {
      try {
        normalized = wanakana.toHiragana(text);
      } catch(e) {
        console.warn('wanakana conversion failed:', e);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚«ã‚¿ã‚«ãƒŠã‚’ã²ã‚‰ãŒãªã«å¤‰æ›
        normalized = text.replace(/[\u30A1-\u30F6]/g, function(match) {
          return String.fromCharCode(match.charCodeAt(0) - 0x60);
        });
      }
    } else {
      // wanaKanaãŒä½¿ãˆãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      normalized = text.replace(/[\u30A1-\u30F6]/g, function(match) {
        return String.fromCharCode(match.charCodeAt(0) - 0x60);
      });
    }
    
    // å¥èª­ç‚¹ã€ã‚¹ãƒšãƒ¼ã‚¹ã€è¨˜å·ã‚’å‰Šé™¤
    return normalized.replace(/[ã€ã€‚ï¼ï¼Ÿ\s,.?!]/g, '').toLowerCase();
  }
  
  function checkAnswer(answer) {
    if (!gameActive) return;
    
    const normalizedAnswer = normalizeText(answer);
    const normalizedQuestion = normalizeText(currentQuestion);
    
    console.log('å•é¡Œ:', currentQuestion, 'â†’', normalizedQuestion);
    console.log('å›ç­”:', answer, 'â†’', normalizedAnswer);
    console.log('ä¸€è‡´:', normalizedAnswer === normalizedQuestion);
    
    if (normalizedAnswer === normalizedQuestion) {
      score += 100 + (combo * 10);
      combo++;
      correctCount++;
      if (combo > maxCombo) maxCombo = combo;
      
      // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹åŠ¹æœéŸ³ã¨ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
      if (combo >= 5) {
        playSound('comboSound');
        comboEl.classList.add('combo-highlight');
      } else {
        comboEl.classList.remove('combo-highlight');
      }
      
      resultDisplayEl.textContent = combo >= 5 ? `æ­£è§£ï¼ ${combo}ã‚³ãƒ³ãƒœï¼` : 'æ­£è§£ï¼';
      resultDisplayEl.className = 'result-display correct';
      playSound('correct');
      
      // æ­£è§£æ™‚ã¯éŸ³å£°èªè­˜çµæœã‚’ã‚¯ãƒªã‚¢
      setTimeout(() => {
        recognizedTextEl.textContent = '...';
        interimTextEl.textContent = '';
      }, 800);
      
    } else {
      combo = 0;
      missCount++;
      comboEl.classList.remove('combo-highlight');
      
      resultDisplayEl.textContent = 'æ®‹å¿µï¼';
      resultDisplayEl.className = 'result-display incorrect';
      playSound('incorrect');
      
      // ä¸æ­£è§£æ™‚ã‚‚éŸ³å£°èªè­˜çµæœã‚’ã‚¯ãƒªã‚¢
      setTimeout(() => {
        recognizedTextEl.textContent = '...';
        interimTextEl.textContent = '';
      }, 1500);
    }
    
    scoreEl.textContent = score;
    comboEl.textContent = combo;
    
    setTimeout(() => {
      resultDisplayEl.textContent = '';
      resultDisplayEl.className = 'result-display';
    }, 1000);
    
    // æ¬¡ã®å•é¡Œã¸ã®åˆ‡ã‚Šæ›¿ãˆå‰ã«éŸ³å£°èªè­˜ã‚’ä¸€æ™‚åœæ­¢
    recognition.stop();
    setTimeout(() => {
      nextQuestion();
      if (gameActive) {
        try {
          recognition.start();
        } catch(e) {
          console.error("Recognition restart failed:", e);
        }
      }
    }, 1200);
  }
  
  initialize();
});
</script>

</body>
</html>
